# afl (foundation library)
# used for all new stuff
inherit:
  - copy

depends:
  - tools::buildsys
  - libs::cxxtest

checkoutVars: [CVSROOT]
checkoutSCM:
  scm: cvs
  cvsroot: ${CVSROOT}
  module: afl

multiPackage:
  # Regular binary package
  bin:
    inherit: [make]
    buildScript: |
      perl "$2"/Make.pl IN="$1" OUT="." CXXTESTDIR="${BOB_DEP_PATHS[libs::cxxtest]}" CXX="${CXX}" CXXFLAGS="${CXXFLAGS}" LDFLAGS="${LDFLAGS}" TARGET="${TARGET:-POSIX}" RUN="${RUN:-}"
      doMake
      doMake test
      doMake install

    packageScript: |
      shallowCopy "$1/result" .

  host:
    depends:
      - libs::afl-bin
    environment:
      CC: ${HOSTCC}
      CXX: ${HOSTCXX}
      CFLAGS: ${HOSTCFLAGS}
      CXXFLAGS: ${HOSTCXXFLAGS}
      LDFLAGS: ${HOSTLDFLAGS}
      CROSS_COMPILE: ""
      TARGET: "POSIX"
      RUN: ""
    buildScript: |
      shallowCopy "${BOB_DEP_PATHS[libs::afl-bin]}" .
    packageScript: |
      shallowCopy "$1" .

  # Coverage report
  cov:
    inherit: [make]
# #     inherit: [coverage]
    buildScript: |
      # Build with coverage enabled
      perl "$2"/Make.pl IN="$1" OUT="." CXXTESTDIR="${BOB_DEP_PATHS[libs::cxxtest]}" CXX="${CXX}" CXXFLAGS="${CXXFLAGS}" LDFLAGS="${LDFLAGS}" TARGET="${TARGET:-POSIX}" RUN="${RUN:-}" --with-coverage
      doMake
# #       # Initialize
# #       coverage_init
# #
# #       # Run tests (generates *.gcda)
# #       ./testsuite
# #
# #       # Create coverage
# #       coverage_create afl "$PWD/afl/*" "$PWD/config/*" "$PWD/arch/*"
# #
    packageScript: |
      true
# #       shallowCopy "$1/coverage_report" .

  # Documentation
  doxy:
    inherit: [doxygen]
    buildScript: |
      buildDoxygen "$1"

    packageScript: |
      packageDoxygen "$1"

  tags:
    buildScript: |
      perl "$2"/Make.pl IN="$1" OUT="."
      make tags

    packageScript: |
      cp "$1/TAGS" .
